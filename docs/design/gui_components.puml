@startuml GUI Package Structure

title GUI Abstraction - Package & Component Diagram
footer Last Updated: 2025-12-02 | A6: AnimatableViewer Protocol Added

skinparam componentStyle rectangle

package "src/cube" {

    ' ============================================
    ' MODEL (unchanged)
    ' ============================================
    package "model" as model_pkg #LightGreen {
        component [Cube] as cube_comp
        component [Face] as face_comp
        component [Part\n(Edge/Corner/Center)] as part_comp
        component [CubeQueries2] as queries_comp
    }

    package "operator" as op_pkg #LightGreen {
        component [Operator] as operator_comp
    }

    package "solver" as solver_pkg #LightGreen {
        component [Solver] as solver_comp
    }

    package "algs" as algs_pkg #LightGreen {
        component [Alg] as alg_comp
    }

    ' ============================================
    ' GUI ABSTRACTION (✅ implemented)
    ' ============================================
    package "gui ✅" as gui_pkg #90EE90 {

        package "protocols ✅" as proto_pkg {
            component [Renderer] as renderer_proto
            component [Window] as window_proto
            component [EventLoop] as loop_proto
            component [AnimationBackend] as anim_proto
            component [AnimatableViewer ✅\n(A6: clean layer separation)] as animatable_viewer_proto
        }

        component [types.py ✅\n(Point3D, Color3,\nKeyEvent, MouseEvent,\nDisplayList, TextureHandle)] as types_comp

        component [factory.py ✅\n(GUIBackend,\nBackendRegistry)] as factory_comp

        component [context.py ✅\n(RenderingContext)] as context_comp

        package "backends" as backends_pkg {

            package "pyglet ✅" as pyglet_pkg #90EE90 {
                component [PygletRenderer\n(OpenGL calls here)] as pyg_renderer
                component [PygletWindow] as pyg_window
                component [PygletEventLoop] as pyg_loop
                component [PygletAnimation] as pyg_anim
                component [PygletAppWindow\n(own handle_key -\nmetaclass conflict)] as pyg_app_window
            }

            package "headless ✅" as headless_pkg #90EE90 {
                component [HeadlessRenderer\n(no-op)] as hl_renderer
                component [HeadlessWindow\n(event queue)] as hl_window
                component [HeadlessEventLoop] as hl_loop
                component [HeadlessAppWindow\n(inherits AppWindowBase)] as hl_app_window
            }

            package "tkinter ✅" as tk_pkg #90EE90 {
                component [TkinterRenderer\n(Canvas 2D)] as tk_renderer
                component [TkinterWindow] as tk_window
                component [TkinterEventLoop] as tk_loop
                component [TkinterAppWindow\n(inherits AppWindowBase)] as tk_app_window
            }

            package "console ✅" as console_pkg #90EE90 {
                component [ConsoleRenderer\n(text output)] as con_renderer
                component [ConsoleEventLoop] as con_loop
                component [ConsoleAppWindow\n(inherits AppWindowBase)] as con_app_window
            }
        }
    }

    ' ============================================
    ' VIEWER (✅ migrated + A6)
    ' ============================================
    package "viewer ✅" as viewer_pkg #90EE90 {
        component [GCubeViewer ✅\n+renderer param\n+cube property\n**A6:** +create_animation()\nimplements AnimatableViewer] as gviewer_comp
        component [_Board\n+renderer param ✅\n+call_lists ✅] as board_comp
        component [_Cell\n+renderer prop ✅\n+display_lists ✅\n+shapes.* ✅] as cell_comp
        component [_FaceBoard\n+board prop ✅] as faceboard_comp

        component [shapes.py\n(fallback only)] as shapes_comp #FFFFE0
        component [texture.py ⏳\n(Move to renderer)] as texture_comp #FFB6C1
        component [gl_helper.py ⏳] as glhelper_comp #FFB6C1
    }

    ' ============================================
    ' ANIMATION (✅ migrated + A6)
    ' ============================================
    package "animation ✅" as anim_pkg #90EE90 {
        component [AnimationManager\n+set_event_loop() ✅\nuses EventLoop protocol\n**A6:** uses AnimatableViewer\n(no duck-typing!)] as anim_mgr_comp
    }

    ' ============================================
    ' APP (partial - pyglet backend)
    ' ============================================
    package "app" as app_pkg #FFFFE0 {
        component [AbstractApp] as app_comp
        component [ApplicationAndViewState\n(pyglet backend code)] as state_comp
    }

    ' ============================================
    ' MAIN WINDOW (✅ migrated)
    ' ============================================
    package "main_window ✅" as mainwin_pkg #90EE90 {
        component [Window\n(pyglet-specific)] as win_comp
        component [AbstractWindow\n(Protocol) ✅] as abstract_win_comp
        component [AppWindowBase ✅\n(handle_key,\ninject_key,\ninject_key_sequence)] as app_window_base
        component [KeyboardInput ✅\nuses Keys protocol] as key_comp
        component [MouseInput ✅\nuses MouseButton protocol] as mouse_comp
    }

    note right of app_window_base
        ✅ Base class for AppWindows
        Tkinter, Console, Headless inherit
        Pyglet cannot (metaclass conflict)
    end note

    ' ============================================
    ' ENTRY POINTS
    ' ============================================
    component [main_pyglet.py ✅\n(uses get_backend())] as main_g #90EE90
    component [Window ✅\n(accepts backend,\ngets renderer)] as win_entry #90EE90
    component [GUITestRunner ✅\n(uses get_backend())] as test_runner #90EE90
    component [main_c.py ✅\n(no GUI)] as main_c #90EE90
}

' ============================================
' EXTERNAL DEPENDENCIES
' ============================================
cloud "pyglet" as pyglet_ext #Pink
cloud "tkinter" as tk_ext #Wheat
cloud "OpenGL" as gl_ext #Pink

' ============================================
' RELATIONSHIPS
' ============================================

' Protocol implementations
pyg_renderer ..|> renderer_proto
pyg_window ..|> window_proto
pyg_loop ..|> loop_proto
pyg_anim ..|> anim_proto

hl_renderer ..|> renderer_proto
hl_window ..|> window_proto
hl_loop ..|> loop_proto

tk_renderer ..|> renderer_proto
tk_window ..|> window_proto
tk_loop ..|> loop_proto

' Factory creates backends
factory_comp --> pyglet_pkg : creates
factory_comp --> headless_pkg : creates
factory_comp --> tk_pkg : creates
factory_comp --> console_pkg : creates

' Viewer uses protocols (goal - partial)
gviewer_comp --> renderer_proto : uses (partial)
board_comp --> renderer_proto : uses (partial)
cell_comp --> renderer_proto : uses (partial)

' Viewer reads model
gviewer_comp --> cube_comp : reads

' Animation uses protocols (✅ done + A6)
anim_mgr_comp --> loop_proto : "✅ uses EventLoop"
anim_mgr_comp --> animatable_viewer_proto : "✅ A6: uses AnimatableViewer"
gviewer_comp ..|> animatable_viewer_proto : implements

' App coordinates everything
app_comp --> operator_comp
app_comp --> solver_comp
app_comp --> state_comp

' Main window uses protocols (✅ done)
abstract_win_comp ..|> window_proto : implements
win_comp --> abstract_win_comp : implements

' Entry point uses factory (✅ done)
main_g --> factory_comp : "✅ get_backend()"
test_runner --> factory_comp : "✅ get_backend()"
main_g --> win_entry : "✅ passes backend"
win_entry --> gviewer_comp : "✅ passes renderer"
main_g --> app_comp

' External dependencies (ONLY in pyglet backend after migration)
pyg_renderer --> pyglet_ext
pyg_renderer --> gl_ext
pyg_window --> pyglet_ext
pyg_loop --> pyglet_ext

tk_renderer --> tk_ext
tk_window --> tk_ext
tk_loop --> tk_ext

' Fallback dependencies (used when no renderer)
shapes_comp ..> gl_ext : fallback only
texture_comp --> gl_ext : ⚠️ pending
state_comp --> gl_ext : ⚠️ pending
win_comp --> pyglet_ext : some GL calls

' Notes
note right of headless_pkg
    No external dependencies
    Used for fast testing
    ✅ Fully implemented
end note

note bottom of proto_pkg
    Protocols define contracts
    No implementation details
    ✅ Fully implemented
end note

note bottom of shapes_comp
    Fallback only
    Used when renderer=None
end note

note right of viewer_pkg
    ✅ Viewer fully migrated
    Uses renderer.shapes.*
    Uses renderer.display_lists.*
    **No fallback** - renderer required
end note

@enduml

' ============================================
' SEPARATE DIAGRAM: Module Composition
' ============================================
@startuml Module Composition

title Module Composition - Who Contains What
footer Last Updated: 2025-11-30 | debug_all added to ApplicationAndViewState

skinparam classAttributeIconSize 0
skinparam linetype ortho

' ============================================
' CORE MODEL
' ============================================
package "model" #LightGreen {
    class Cube {
        +faces: Face[6]
        +parts: PartSlice[]
        +cqr: CubeQueries2
        +solved: bool
        +_modify_counter: int
    }

    class CubeQueries2 {
        +get_sate(): CubeState
        +compare_state()
    }

    Cube *-- CubeQueries2 : cqr
}

' ============================================
' APPLICATION STATE
' ============================================
package "app" #LightYellow {
    class ApplicationAndViewState {
        -_debug_all: bool
        -_speed: int
        -_alpha_x, _alpha_y, _alpha_z: float
        -_fov_y: float
        -_offset: list
        +cube_size: int
        ..
        +is_debug_all: bool
        +debug(*args)
        +debug_dump_cube_state(cube, label)
        ..
        +prepare_objects_view(renderer)
        +restore_objects_view(renderer)
        +set_projection(w, h, renderer)
        +get_speed: AnimationSpeed
    }

    class "_App (AbstractApp)" as App {
        -_vs: ApplicationAndViewState
        -_cube: Cube
        -_op: Operator
        -_am: AnimationManager
        -_slv: Solver
        ..
        +vs: ApplicationAndViewState
        +cube: Cube
        +op: Operator
        +am: AnimationManager
        +slv: Solver
    }

    App *-- ApplicationAndViewState : _vs
    App *-- Cube : _cube
}

' ============================================
' OPERATOR
' ============================================
package "operator" #LightGreen {
    class Operator {
        -_cube: Cube
        -_app_state: ApplicationAndViewState
        -_animation_manager: AnimationManager
        -_annotation: OpAnnotation
        ..
        +app_state: ApplicationAndViewState
        +play(alg)
        +log(*s)
    }

    Operator o-- ApplicationAndViewState : _app_state
    Operator o-- Cube : _cube
}

' ============================================
' ANIMATION
' ============================================
package "animation" #90EE90 {
    class AnimationManager {
        -_vs: ApplicationAndViewState
        -_event_loop: EventLoop
        ..
        +set_event_loop(loop)
        +run_animation(update, on_complete)
    }

    AnimationManager o-- ApplicationAndViewState : _vs
}

' ============================================
' SOLVER
' ============================================
package "solver" #LightGreen {
    class BaseSolver {
        -_op: Operator
        -_cube: Cube
        ..
        +is_debug_config_mode: bool
        +debug(*args)
    }

    BaseSolver o-- Operator : _op
    BaseSolver o-- Cube : _cube

    note right of BaseSolver
        is_debug_config_mode checks:
        1. op.app_state.is_debug_all
        2. config.SOLVER_DEBUG
    end note
}

' ============================================
' GUI BACKEND
' ============================================
package "gui" #LightBlue {
    class GUIBackend {
        -_renderer: Renderer
        -_event_loop: EventLoop
        ..
        +renderer: Renderer (lazy)
        +event_loop: EventLoop
    }

    interface Renderer {
        +shapes: ShapeRenderer
        +display_lists: DisplayListManager
        +view: ViewStateManager
    }

    interface EventLoop {
        +run()
        +stop()
        +schedule_once()
    }

    GUIBackend *-- Renderer : _renderer (lazy)
    GUIBackend *-- EventLoop : creates
}

' ============================================
' MAIN WINDOW
' ============================================
package "main_window" #90EE90 {
    class AppWindowBase {
        #_app: AbstractApp
        #_backend: GUIBackend
        ..
        +app: AbstractApp
        +handle_key(symbol, modifiers)
    }

    class "Window (Pyglet)" as Window {
        -_viewer: GCubeViewer
        -_renderer: Renderer
        ..
        +renderer: Renderer
        +viewer: GCubeViewer
    }

    AppWindowBase o-- App : _app
    AppWindowBase o-- GUIBackend : _backend
    Window o-- Renderer : _renderer
}

' ============================================
' VIEWER
' ============================================
package "viewer" #90EE90 {
    class GCubeViewer {
        -_renderer: Renderer
        -_board: _Board
        ..
        +renderer: Renderer
    }

    GCubeViewer o-- Renderer : _renderer
}

' ============================================
' CROSS-PACKAGE RELATIONSHIPS
' ============================================
App *-- Operator : _op
App *-- AnimationManager : _am
App *-- BaseSolver : _slv

' App is the central coordinator
note bottom of App
    **App is the central coordinator**
    Created by AbstractApp.create_non_default()

    Contains:
    - ApplicationAndViewState (view config + debug)
    - Cube (model)
    - Operator (mutations)
    - AnimationManager (animation)
    - Solver (AI)
end note

' ApplicationAndViewState is shared
note right of ApplicationAndViewState
    **Shared state object**
    Created first, passed to:
    - _App (owns it)
    - Operator (reference)
    - AnimationManager (reference)

    **New debug_all support:**
    - is_debug_all property
    - debug() method
    - debug_dump_cube_state()
end note

@enduml
