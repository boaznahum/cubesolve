@startuml GUI Package Structure

title GUI Abstraction - Package & Component Diagram
footer Last Updated: 2025-11-27 | ‚úÖ = Done | üîÑ = In Progress | ‚è≥ = Pending

skinparam componentStyle rectangle

package "src/cube" {

    ' ============================================
    ' MODEL (unchanged)
    ' ============================================
    package "model" as model_pkg #LightGreen {
        component [Cube] as cube_comp
        component [Face] as face_comp
        component [Part\n(Edge/Corner/Center)] as part_comp
        component [CubeQueries2] as queries_comp
    }

    package "operator" as op_pkg #LightGreen {
        component [Operator] as operator_comp
    }

    package "solver" as solver_pkg #LightGreen {
        component [Solver] as solver_comp
    }

    package "algs" as algs_pkg #LightGreen {
        component [Alg] as alg_comp
    }

    ' ============================================
    ' GUI ABSTRACTION (‚úÖ implemented)
    ' ============================================
    package "gui ‚úÖ" as gui_pkg #90EE90 {

        package "protocols ‚úÖ" as proto_pkg {
            component [Renderer] as renderer_proto
            component [Window] as window_proto
            component [EventLoop] as loop_proto
            component [AnimationBackend] as anim_proto
        }

        component [types.py ‚úÖ\n(Point3D, Color3,\nKeyEvent, MouseEvent,\nDisplayList, TextureHandle)] as types_comp

        component [factory.py ‚úÖ\n(BackendRegistry,\ncreate_gui)] as factory_comp

        component [context.py ‚úÖ\n(RenderingContext)] as context_comp

        package "backends" as backends_pkg {

            package "pyglet ‚úÖ" as pyglet_pkg #90EE90 {
                component [PygletRenderer\n(OpenGL calls here)] as pyg_renderer
                component [PygletWindow] as pyg_window
                component [PygletEventLoop] as pyg_loop
                component [PygletAnimation] as pyg_anim
            }

            package "headless ‚úÖ" as headless_pkg #90EE90 {
                component [HeadlessRenderer\n(no-op)] as hl_renderer
                component [HeadlessWindow\n(event queue)] as hl_window
                component [HeadlessEventLoop] as hl_loop
            }

            package "tkinter ‚è≥" as tk_pkg #Wheat {
                component [TkinterRenderer\n(Canvas 2D)] as tk_renderer
                component [TkinterWindow] as tk_window
                component [TkinterEventLoop] as tk_loop
            }
        }
    }

    ' ============================================
    ' VIEWER (üîÑ migration in progress)
    ' ============================================
    package "viewer üîÑ" as viewer_pkg #FFFFE0 {
        component [GCubeViewer\n+renderer param ‚úÖ] as gviewer_comp
        component [_Board\n+renderer param ‚úÖ\ngl.* calls ‚è≥] as board_comp
        component [_Cell\n+renderer prop ‚úÖ\ndisplay_lists üîÑ\nshapes.* ‚è≥] as cell_comp
        component [_FaceBoard\n+board prop ‚úÖ] as faceboard_comp

        component [shapes.py ‚è≥\n(DELETE after migration)] as shapes_comp #FFB6C1
        component [texture.py ‚è≥\n(Move to renderer)] as texture_comp #FFB6C1
        component [gl_helper.py ‚è≥] as glhelper_comp #FFB6C1
    }

    ' ============================================
    ' ANIMATION (‚è≥ pending)
    ' ============================================
    package "animation ‚è≥" as anim_pkg #FFFFE0 {
        component [AnimationManager\n(still uses pyglet.clock)] as anim_mgr_comp
    }

    ' ============================================
    ' APP (‚è≥ pending)
    ' ============================================
    package "app ‚è≥" as app_pkg #FFFFE0 {
        component [AbstractApp] as app_comp
        component [ApplicationAndViewState\n(still uses gl.* calls)] as state_comp #FFB6C1
    }

    ' ============================================
    ' MAIN WINDOW (‚è≥ pending)
    ' ============================================
    package "main_window ‚è≥" as mainwin_pkg #FFFFE0 {
        component [Window\n(extends pyglet.window)] as win_comp #FFB6C1
        component [KeyboardInput] as key_comp
        component [MouseInput] as mouse_comp
    }

    ' ============================================
    ' ENTRY POINTS
    ' ============================================
    component [main_g.py ‚è≥\n(should use create_gui)] as main_g #FFFFE0
    component [main_c.py ‚úÖ\n(no GUI)] as main_c #90EE90
}

' ============================================
' EXTERNAL DEPENDENCIES
' ============================================
cloud "pyglet" as pyglet_ext #Pink
cloud "tkinter" as tk_ext #Wheat
cloud "OpenGL" as gl_ext #Pink

' ============================================
' RELATIONSHIPS
' ============================================

' Protocol implementations
pyg_renderer ..|> renderer_proto
pyg_window ..|> window_proto
pyg_loop ..|> loop_proto
pyg_anim ..|> anim_proto

hl_renderer ..|> renderer_proto
hl_window ..|> window_proto
hl_loop ..|> loop_proto

tk_renderer ..|> renderer_proto
tk_window ..|> window_proto
tk_loop ..|> loop_proto

' Factory creates backends
factory_comp --> pyglet_pkg : creates
factory_comp --> headless_pkg : creates
factory_comp --> tk_pkg : creates (future)

' Viewer uses protocols (goal - partial)
gviewer_comp --> renderer_proto : uses (partial)
board_comp --> renderer_proto : uses (partial)
cell_comp --> renderer_proto : uses (partial)

' Viewer reads model
gviewer_comp --> cube_comp : reads

' Animation uses protocol (pending)
anim_mgr_comp ..> anim_proto : should use

' App coordinates everything
app_comp --> operator_comp
app_comp --> solver_comp
app_comp --> state_comp

' Main window should use protocols (pending)
win_comp ..> window_proto : should use
win_comp ..> loop_proto : should use

' Entry point should use factory (pending)
main_g ..> factory_comp : should use create_gui()
main_g --> app_comp
main_g --> gviewer_comp

' External dependencies (ONLY in pyglet backend after migration)
pyg_renderer --> pyglet_ext
pyg_renderer --> gl_ext
pyg_window --> pyglet_ext
pyg_loop --> pyglet_ext

tk_renderer --> tk_ext
tk_window --> tk_ext
tk_loop --> tk_ext

' Current problematic dependencies (to be removed)
shapes_comp --> gl_ext : ‚ö†Ô∏è remove
texture_comp --> gl_ext : ‚ö†Ô∏è remove
state_comp --> gl_ext : ‚ö†Ô∏è remove
win_comp --> pyglet_ext : ‚ö†Ô∏è remove

' Notes
note right of headless_pkg
    No external dependencies
    Used for fast testing
    ‚úÖ Fully implemented
end note

note bottom of proto_pkg
    Protocols define contracts
    No implementation details
    ‚úÖ Fully implemented
end note

note bottom of shapes_comp
    Will be DELETED
    after migration complete
end note

@enduml
