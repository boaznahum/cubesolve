@startuml GUI Package Structure

title GUI Abstraction - Package & Component Diagram
footer Last Updated: 2025-11-28 | Migration Complete ✅

skinparam componentStyle rectangle

package "src/cube" {

    ' ============================================
    ' MODEL (unchanged)
    ' ============================================
    package "model" as model_pkg #LightGreen {
        component [Cube] as cube_comp
        component [Face] as face_comp
        component [Part\n(Edge/Corner/Center)] as part_comp
        component [CubeQueries2] as queries_comp
    }

    package "operator" as op_pkg #LightGreen {
        component [Operator] as operator_comp
    }

    package "solver" as solver_pkg #LightGreen {
        component [Solver] as solver_comp
    }

    package "algs" as algs_pkg #LightGreen {
        component [Alg] as alg_comp
    }

    ' ============================================
    ' GUI ABSTRACTION (✅ implemented)
    ' ============================================
    package "gui ✅" as gui_pkg #90EE90 {

        package "protocols ✅" as proto_pkg {
            component [Renderer] as renderer_proto
            component [Window] as window_proto
            component [EventLoop] as loop_proto
            component [AnimationBackend] as anim_proto
        }

        component [types.py ✅\n(Point3D, Color3,\nKeyEvent, MouseEvent,\nDisplayList, TextureHandle)] as types_comp

        component [factory.py ✅\n(GUIBackend,\nBackendRegistry)] as factory_comp

        component [context.py ✅\n(RenderingContext)] as context_comp

        package "backends" as backends_pkg {

            package "pyglet ✅" as pyglet_pkg #90EE90 {
                component [PygletRenderer\n(OpenGL calls here)] as pyg_renderer
                component [PygletWindow] as pyg_window
                component [PygletEventLoop] as pyg_loop
                component [PygletAnimation] as pyg_anim
            }

            package "headless ✅" as headless_pkg #90EE90 {
                component [HeadlessRenderer\n(no-op)] as hl_renderer
                component [HeadlessWindow\n(event queue)] as hl_window
                component [HeadlessEventLoop] as hl_loop
            }

            package "tkinter ⏳" as tk_pkg #Wheat {
                component [TkinterRenderer\n(Canvas 2D)] as tk_renderer
                component [TkinterWindow] as tk_window
                component [TkinterEventLoop] as tk_loop
            }
        }
    }

    ' ============================================
    ' VIEWER (✅ migrated)
    ' ============================================
    package "viewer ✅" as viewer_pkg #90EE90 {
        component [GCubeViewer\n+renderer param ✅] as gviewer_comp
        component [_Board\n+renderer param ✅\n+call_lists ✅] as board_comp
        component [_Cell\n+renderer prop ✅\n+display_lists ✅\n+shapes.* ✅] as cell_comp
        component [_FaceBoard\n+board prop ✅] as faceboard_comp

        component [shapes.py\n(fallback only)] as shapes_comp #FFFFE0
        component [texture.py ⏳\n(Move to renderer)] as texture_comp #FFB6C1
        component [gl_helper.py ⏳] as glhelper_comp #FFB6C1
    }

    ' ============================================
    ' ANIMATION (✅ migrated)
    ' ============================================
    package "animation ✅" as anim_pkg #90EE90 {
        component [AnimationManager\n+set_event_loop() ✅\nuses EventLoop protocol] as anim_mgr_comp
    }

    ' ============================================
    ' APP (partial - pyglet backend)
    ' ============================================
    package "app" as app_pkg #FFFFE0 {
        component [AbstractApp] as app_comp
        component [ApplicationAndViewState\n(pyglet backend code)] as state_comp
    }

    ' ============================================
    ' MAIN WINDOW (✅ migrated)
    ' ============================================
    package "main_window ✅" as mainwin_pkg #90EE90 {
        component [Window\n(pyglet-specific)] as win_comp
        component [AbstractWindow\n(Protocol) ✅] as abstract_win_comp
        component [KeyboardInput ✅\nuses Keys protocol] as key_comp
        component [MouseInput ✅\nuses MouseButton protocol] as mouse_comp
    }

    ' ============================================
    ' ENTRY POINTS
    ' ============================================
    component [main_pyglet.py ✅\n(uses get_backend())] as main_g #90EE90
    component [Window ✅\n(accepts backend,\ngets renderer)] as win_entry #90EE90
    component [GUITestRunner ✅\n(uses get_backend())] as test_runner #90EE90
    component [main_c.py ✅\n(no GUI)] as main_c #90EE90
}

' ============================================
' EXTERNAL DEPENDENCIES
' ============================================
cloud "pyglet" as pyglet_ext #Pink
cloud "tkinter" as tk_ext #Wheat
cloud "OpenGL" as gl_ext #Pink

' ============================================
' RELATIONSHIPS
' ============================================

' Protocol implementations
pyg_renderer ..|> renderer_proto
pyg_window ..|> window_proto
pyg_loop ..|> loop_proto
pyg_anim ..|> anim_proto

hl_renderer ..|> renderer_proto
hl_window ..|> window_proto
hl_loop ..|> loop_proto

tk_renderer ..|> renderer_proto
tk_window ..|> window_proto
tk_loop ..|> loop_proto

' Factory creates backends
factory_comp --> pyglet_pkg : creates
factory_comp --> headless_pkg : creates
factory_comp --> tk_pkg : creates (future)

' Viewer uses protocols (goal - partial)
gviewer_comp --> renderer_proto : uses (partial)
board_comp --> renderer_proto : uses (partial)
cell_comp --> renderer_proto : uses (partial)

' Viewer reads model
gviewer_comp --> cube_comp : reads

' Animation uses protocol (✅ done)
anim_mgr_comp --> loop_proto : "✅ uses EventLoop"

' App coordinates everything
app_comp --> operator_comp
app_comp --> solver_comp
app_comp --> state_comp

' Main window uses protocols (✅ done)
abstract_win_comp ..|> window_proto : implements
win_comp --> abstract_win_comp : implements

' Entry point uses factory (✅ done)
main_g --> factory_comp : "✅ get_backend()"
test_runner --> factory_comp : "✅ get_backend()"
main_g --> win_entry : "✅ passes backend"
win_entry --> gviewer_comp : "✅ passes renderer"
main_g --> app_comp

' External dependencies (ONLY in pyglet backend after migration)
pyg_renderer --> pyglet_ext
pyg_renderer --> gl_ext
pyg_window --> pyglet_ext
pyg_loop --> pyglet_ext

tk_renderer --> tk_ext
tk_window --> tk_ext
tk_loop --> tk_ext

' Fallback dependencies (used when no renderer)
shapes_comp ..> gl_ext : fallback only
texture_comp --> gl_ext : ⚠️ pending
state_comp --> gl_ext : ⚠️ pending
win_comp --> pyglet_ext : some GL calls

' Notes
note right of headless_pkg
    No external dependencies
    Used for fast testing
    ✅ Fully implemented
end note

note bottom of proto_pkg
    Protocols define contracts
    No implementation details
    ✅ Fully implemented
end note

note bottom of shapes_comp
    Fallback only
    Used when renderer=None
end note

note right of viewer_pkg
    ✅ Viewer fully migrated
    Uses renderer.shapes.*
    Uses renderer.display_lists.*
    **No fallback** - renderer required
end note

@enduml
