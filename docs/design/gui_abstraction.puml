@startuml GUI Abstraction Architecture

title GUI Abstraction Layer - Architecture Diagram
footer Last Updated: 2025-11-30 | AppWindow Inheritance Added

skinparam packageStyle rectangle
skinparam linetype ortho

' ============================================
' MODEL LAYER (unchanged)
' ============================================
package "Model Layer (unchanged)" as model #LightGreen {
    class Cube {
        +faces: Face[6]
        +edges: Edge[12]
        +corners: Corner[8]
        +rotate_face()
        +solved: bool
    }

    class Operator {
        +play(alg: Alg)
        +undo()
        +history: Alg[]
    }

    class Solver {
        +solve()
        +is_solved: bool
    }

    Operator --> Cube : mutates
    Solver --> Operator : uses
}

' ============================================
' GUI PROTOCOLS (implemented)
' ============================================
package "cube.gui.protocols" as protocols #LightBlue {

    interface Renderer <<protocol>> {
        +shapes: ShapeRenderer
        +display_lists: DisplayListManager
        +view: ViewStateManager
        +clear(color)
        +setup()
        +cleanup()
        +begin_frame()
        +end_frame()
        +flush()
        +load_texture(path): TextureHandle
        +bind_texture(handle)
        +delete_texture(handle)
    }

    interface ShapeRenderer <<protocol>> {
        +quad(vertices, color)
        +quad_with_border(vertices, face_color, line_width, line_color)
        +quad_with_texture(vertices, color, texture, texture_map)
        +triangle(vertices, color)
        +line(p1, p2, width, color)
        +lines(points, width, color)
        +sphere(center, radius, color)
        +cylinder(p1, p2, r1, r2, color)
        +disk(center, normal, inner_r, outer_r, color)
    }

    interface DisplayListManager <<protocol>> {
        +create_list(): DisplayList
        +begin_compile(list_id)
        +end_compile()
        +call_list(list_id)
        +call_lists(list_ids)
        +delete_list(list_id)
        +delete_lists(list_ids)
    }

    interface ViewStateManager <<protocol>> {
        +set_projection(w, h, fov, near, far)
        +push_matrix()
        +pop_matrix()
        +load_identity()
        +translate(x, y, z)
        +rotate(angle, x, y, z)
        +scale(x, y, z)
        +multiply_matrix(matrix)
        +look_at(eye, center, up)
    }

    interface Window <<protocol>> {
        +width: int
        +height: int
        +text: TextRenderer
        +set_draw_handler(handler)
        +set_resize_handler(handler)
        +set_key_press_handler(handler)
        +set_key_release_handler(handler)
        +set_mouse_press_handler(handler)
        +set_mouse_drag_handler(handler)
        +set_close_handler(handler)
        +request_redraw()
        +close()
    }

    interface EventLoop <<protocol>> {
        +running: bool
        +run()
        +stop()
        +step(): bool
        +get_time(): float
        +schedule_once(callback, delay)
        +schedule_interval(callback, interval)
        +unschedule(callback)
    }

    interface AnimationBackend <<protocol>> {
        +supported: bool
        +running: bool
        +speed: float
        +run_animation(update_func, on_complete, interval)
        +cancel()
        +pause()
        +resume()
        +skip()
    }

    Renderer *-- ShapeRenderer
    Renderer *-- DisplayListManager
    Renderer *-- ViewStateManager
}

' ============================================
' TYPES (implemented)
' ============================================
package "cube.gui.types" as types_pkg #LightYellow {
    class KeyEvent <<dataclass>> {
        +symbol: int
        +modifiers: int
        +char: str | None
    }

    class MouseEvent <<dataclass>> {
        +x: int
        +y: int
        +dx: int
        +dy: int
        +button: int
        +modifiers: int
    }

    class Keys <<constants>> {
        A-Z, 0-9
        ESCAPE, SPACE, RETURN
        LEFT, RIGHT, UP, DOWN
        F1-F12
    }

    class Modifiers <<constants>> {
        SHIFT, CTRL, ALT, META
    }

    class "DisplayList" as DL <<NewType(int)>>
    class "TextureHandle" as TH <<NewType(int)>>
    class "TextureCoord" as TC <<dataclass>>
}

' ============================================
' BACKEND FACTORY (implemented)
' ============================================
package "cube.gui" as gui_root #LightYellow {
    class GUIBackend {
        -_name: str
        -_entry: _BackendEntry
        -_renderer: Renderer | None
        +name: str
        +renderer: Renderer  «lazy singleton»
        +create_window(w, h, title): Window
        +create_event_loop(): EventLoop
        +create_animation(): AnimationBackend | None
        +supports_animation: bool
    }

    class BackendRegistry <<singleton>> {
        -_backends: Dict
        -_default: str
        +register(name, factories...)
        +set_default(name)
        +get_default(): str
        +available(): list[str]
        +get_backend(name): GUIBackend  «primary»
        +create_renderer(backend)  «deprecated»
        +create_window(...)  «deprecated»
        +create_event_loop(backend)  «deprecated»
        +create_animation(backend)  «deprecated»
    }

    BackendRegistry --> GUIBackend : creates
}

' ============================================
' PYGLET BACKEND (implemented)
' ============================================
package "cube.gui.backends.pyglet" as pyglet_backend #90EE90 {
    class PygletRenderer {
        -_shapes: PygletShapeRenderer
        -_display_lists: PygletDisplayListManager
        -_view: PygletViewStateManager
        ' Contains all OpenGL calls
    }

    class PygletShapeRenderer {
        +quad() : gl.glBegin(GL_QUADS)
        +sphere() : glu.gluSphere()
        +cylinder() : glu.gluCylinder()
        +disk() : glu.gluDisk()
    }

    class PygletDisplayListManager {
        +create_list() : gl.glGenLists()
        +call_list() : gl.glCallList()
        +delete_list() : gl.glDeleteLists()
    }

    class PygletViewStateManager {
        +set_projection() : glu.gluPerspective()
        +push_matrix() : gl.glPushMatrix()
        +rotate() : gl.glRotatef()
    }

    class PygletWindow {
        ' extends pyglet.window.Window
        -_key_handler: Callable
        -_draw_handler: Callable
    }

    class PygletEventLoop {
        +run() : pyglet.app.run()
        +stop() : pyglet.app.exit()
    }

    class PygletAnimation {
        +run_animation() : pyglet.clock.schedule_interval()
    }

    PygletRenderer *-- PygletShapeRenderer
    PygletRenderer *-- PygletDisplayListManager
    PygletRenderer *-- PygletViewStateManager
}

' ============================================
' HEADLESS BACKEND (implemented)
' ============================================
package "cube.gui.backends.headless" as headless_backend #90EE90 {
    class HeadlessRenderer {
        ' no-op implementation
        +frame_count: int
    }

    class HeadlessWindow {
        ' mock window for testing
        +queue_key_events()
        +process_queued_key_events()
    }

    class HeadlessEventLoop {
        ' immediate execution
        +step(): bool
    }

    class HeadlessAnimation {
        ' supported = False
    }

    note bottom of HeadlessRenderer
        All methods are no-ops
        for fast testing
        ✅ Fully implemented
    end note
}

' ============================================
' APP WINDOW INHERITANCE (✅ 2025-11-30)
' ============================================
package "cube.main_window" as main_window_pkg #90EE90 {
    abstract class AppWindowBase {
        #_app: AbstractApp
        #_backend: GUIBackend
        #_animation_manager
        +app: AbstractApp
        +animation_running: bool
        ..
        +handle_key(symbol, modifiers) ← protocol method
        +inject_key(key, modifiers)
        +inject_key_sequence(sequence)
        ..
        {abstract} +run()
        {abstract} +close()
        {abstract} #_request_redraw()
        {abstract} +set_mouse_visible()
    }

    note bottom of AppWindowBase
        Base class for AppWindows.
        Provides unified keyboard handling.
        All backends call handle_key().
    end note
}

package "cube.gui.backends" as app_windows_pkg {
    class TkinterAppWindow {
        +handle_key() ← overrides (adds _draw)
        +_on_tk_key_event() ← native handler
    }

    class ConsoleAppWindow {
        ' handle_key() inherited
        +_on_console_key_event() ← native handler
    }

    class HeadlessAppWindow {
        ' handle_key(), inject_key() inherited
    }

    class PygletAppWindow {
        +handle_key() ← own implementation
        +on_key_press() ← native handler (pyglet)
        -- metaclass conflict --
        Cannot inherit AppWindowBase
        (pyglet.window.WindowMeta)
    }
}

AppWindowBase <|-- TkinterAppWindow
AppWindowBase <|-- ConsoleAppWindow
AppWindowBase <|-- HeadlessAppWindow
' PygletAppWindow cannot inherit - metaclass conflict

' ============================================
' TKINTER BACKEND (future)
' ============================================
package "cube.gui.backends.tkinter" as tkinter_backend #Wheat {
    class TkinterRenderer {
        -_canvas: tk.Canvas
        ' 2D isometric projection
    }

    class TkinterWindow {
        -_root: tk.Tk
        -_canvas: tk.Canvas
    }

    class TkinterEventLoop {
        +run() : root.mainloop()
    }

    note bottom of TkinterRenderer
        ⏳ Not yet implemented
        Uses Canvas for 2D
        isometric rendering
    end note
}

' ============================================
' VIEWER LAYER (✅ migrated)
' ============================================
package "cube.viewer ✅" as viewer #90EE90 {
    class GCubeViewer {
        -_renderer: Renderer | None
        -_board: Board
        +update()
        +draw()
    }

    class "_Board" as Board {
        -_renderer: Renderer | None
        -_faces: FaceBoard[6]
        +renderer: property
        ' ✅ Uses renderer.display_lists.call_lists()
    }

    class "_FaceBoard" as FaceBoard {
        +board: _Board
        -_cells: dict[PartFixedID, _Cell]
    }

    class "_Cell" as Cell {
        +_renderer: property
        -gl_lists_movable: dict
        -gl_lists_unmovable: dict
        ' ✅ display_lists migrated
        ' ✅ shapes.* migrated
    }

    note right of Cell
        ✅ Fully migrated
        Uses renderer.shapes.*
        with fallback to direct GL
    end note

    GCubeViewer *-- Board
    Board *-- FaceBoard
    FaceBoard *-- Cell
}

' ============================================
' PYGLET-SPECIFIC CODE (intentional)
' ============================================
package "Pyglet Backend Code" as pyglet_code #FFFFE0 {
    class "shapes.py" as shapes_old {
        ' Part of pyglet backend
        +quad_with_line()
        +sphere()
        +cylinder()
        +disk()
    }

    class "texture.py" as texture_old {
        ' Part of pyglet backend
        +TextureData.load()
    }

    class "ApplicationAndViewState.py" as appstate_old {
        ' Part of pyglet backend
        +prepare_objects_view()
        +restore_objects_view()
    }

    note bottom of shapes_old
        Intentionally kept as
        pyglet backend code.
        Only abstract if adding
        another 3D backend.
    end note
}

' ============================================
' ENTRY POINTS
' ============================================
package "Entry Points" as entry #Lavender {
    class "main_pyglet.py ✅" as main_g {
        +main()
        ' ✅ Uses BackendRegistry.get_backend()
        ' ✅ Passes backend to Window
    }

    class "Window ✅" as app_window {
        +__init__(app, w, h, title, backend: GUIBackend)
        ' ✅ Gets renderer via backend.renderer
        ' ✅ Passes renderer to GCubeViewer
    }

    class "GUITestRunner ✅" as test_runner {
        +run_test(key_sequence, ...)
        ' ✅ Uses BackendRegistry.get_backend()
    }

    class "tests/backends/*" as tests {
        +test_*()
        ' ✅ Uses headless backend
    }

    class "main_c.py" as main_c {
        +run()
        ' Console (no GUI needed)
    }
}

' ============================================
' RELATIONSHIPS
' ============================================

' Protocol implementations
PygletRenderer ..|> Renderer
PygletWindow ..|> Window
PygletEventLoop ..|> EventLoop
PygletAnimation ..|> AnimationBackend

HeadlessRenderer ..|> Renderer
HeadlessWindow ..|> Window
HeadlessEventLoop ..|> EventLoop
HeadlessAnimation ..|> AnimationBackend

TkinterRenderer ..|> Renderer
TkinterWindow ..|> Window
TkinterEventLoop ..|> EventLoop

' GUIBackend uses entries to create instances
GUIBackend --> PygletRenderer : creates (lazy)
GUIBackend --> HeadlessRenderer : creates (lazy)
GUIBackend --> TkinterRenderer : creates (lazy)

' Viewer uses protocols (✅ complete)
GCubeViewer --> Renderer : "✅ uses"
GCubeViewer --> Cube : reads state

' Entry points use factory
main_g --> BackendRegistry : "✅ get_backend()"
test_runner --> BackendRegistry : "✅ get_backend()"
tests --> BackendRegistry : "✅ get_backend()"

' Backend flow: main_g -> Window (backend) -> GCubeViewer (renderer)
main_g --> app_window : "✅ passes backend"
app_window --> GUIBackend : "✅ backend.renderer"
app_window --> GCubeViewer : "✅ passes renderer"

' Entry points use viewer
main_g --> Operator

' Backend code dependencies (pyglet-specific, intentional)
Cell --> shapes_old : "uses (pyglet backend)"
Board --> texture_old : "uses (pyglet backend)"

@enduml
