@startuml GUI Initialization and Rendering Sequence

title GUI Abstraction - Initialization & Rendering Flow
footer Last Updated: 2025-11-28 | Migration Complete ✅

participant "main_pyglet.py" as main
participant "BackendRegistry" as registry
participant "GUIBackend" as backend
participant "Renderer" as renderer
participant "Window\n(main_window)" as window
participant "EventLoop" as loop
participant "GCubeViewer" as viewer
participant "Cube" as cube

== Initialization ==

main -> registry : register("pyglet", factories...)
activate registry
registry --> main
deactivate registry

main -> registry : get_backend("pyglet")
activate registry
registry -> backend ** : GUIBackend(name, entry)
registry --> main : backend
deactivate registry

main -> window ** : Window(app, 720, 720, title, backend)
activate window

window -> backend : backend.renderer
activate backend
backend -> renderer ** : renderer_factory()
backend --> window : renderer (lazy singleton)
deactivate backend

window -> renderer : setup()
activate renderer
renderer --> window
deactivate renderer

window -> viewer ** : GCubeViewer(batch, cube, vs, renderer)
deactivate window

note over window, viewer
    Window receives GUIBackend
    Gets renderer via backend.renderer
    Passes renderer to GCubeViewer
end note

== Event Loop (✅ Abstracted) ==

note over main
    Wire up event loop to animation manager:
    app.am.set_event_loop(backend.event_loop)
end note

main -> backend : backend.event_loop
main -> loop : run()
activate loop
note right: Uses backend.event_loop.run()\nnot direct pyglet.app.run()

loop -> window : process_events()
activate window

window -> main : on_draw()
activate main

main -> renderer : clear()
main -> renderer : view.set_projection(w, h)
main -> viewer : draw()
activate viewer

viewer -> cube : read state (faces, colors)
viewer -> renderer : shapes.quad(vertices, color)
viewer -> renderer : display_lists.call_list(id)

viewer --> main
deactivate viewer

main -> renderer : end_frame()
main --> window
deactivate main

window --> loop
deactivate window

note over loop
    Loop continues until
    window.close() or
    loop.stop() is called
end note

== Key Press Event ==

loop -> window : process_events()
window -> main : on_key(KeyEvent)
activate main

alt Key is cube move (R, L, U, D, F, B)
    main -> cube : Operator.play(alg)
    main -> window : request_redraw()
else Key is quit (Q)
    main -> loop : stop()
end

main --> window
deactivate main

== Animation (if supported) ==

main -> renderer : animation.run_animation(cube, face, slices, n)
activate renderer

loop over animation frames
    renderer -> viewer : update animation state
    renderer -> window : request_redraw()
    window -> main : on_draw()
    main -> viewer : draw() with interpolated transform
end

renderer -> main : on_complete callback
deactivate renderer

main -> cube : apply final rotation

deactivate loop

@enduml
